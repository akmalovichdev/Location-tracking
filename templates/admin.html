<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–µ–π</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body, html { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            display: flex; 
            flex-direction: column; 
            font-family: Arial, sans-serif;
        }
        #map { 
            flex: 1; 
            width: 100%; 
        }
        #control-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 350px;
        }
        #user-list {
            max-height: 250px;
            overflow-y: auto;
            font-size: 14px;
            margin: 10px 0;
        }
        .user-item { 
            cursor: pointer; 
            padding: 10px; 
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .user-item:hover { 
            background: #f8f9fa; 
        }
        .user-item.selected {
            background: #e3f2fd;
            border-left: 3px solid #007bff;
        }
        button { 
            width: 100%; 
            margin-top: 5px; 
            padding: 10px; 
            cursor: pointer; 
            border: none; 
            border-radius: 5px; 
            background: #007bff; 
            color: white; 
            font-size: 14px;
            transition: background-color 0.2s;
        }
        button:hover { 
            background: #0056b3; 
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        #chart-container { 
            display: none; 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            z-index: 1000; 
            width: 400px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .input-group {
            margin: 10px 0;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div id="control-panel">
        <button onclick="window.location.href='/'">–ù–∞–∑–∞–¥</button>
        <button onclick="updateUsers()">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <button onclick="resetView()">–°–±—Ä–æ—Å–∏—Ç—å –∫–∞—Ä—Ç—É</button>
        <button onclick="deleteAllUsers()" class="danger">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
        
        <div class="input-group">
            <input type="text" id="userNameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <button onclick="shareLocation()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π</button>
        </div>

        <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</h3>
        <div id="user-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div id="map"></div>

    <div id="chart-container">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏–π</h3>
        <canvas id="locationChart"></canvas>
        <button onclick="closeChart()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <script>
        var map = L.map('map').setView([39.6548, 66.9750], 13);
        var markers = {};
        var paths = {};
        var userList = document.getElementById("user-list");
        var chartContainer = document.getElementById("chart-container");
        var ctx = document.getElementById("locationChart").getContext("2d");
        var locationChart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: [], 
                datasets: [{ 
                    label: "–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ", 
                    data: [], 
                    borderColor: 'blue', 
                    borderWidth: 2,
                    fill: false
                }] 
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        function resetView() { 
            map.setView([39.6548, 66.9750], 13, { animate: true }); 
        }

        function updateUsers() {
            fetch('/api/get_locations')
                .then(response => response.json())
                .then(data => {
                    userList.innerHTML = "";
                    for (let user in data) {
                        let history = data[user];
                        let latest = history[history.length - 1];
                        let latlng = [latest.latitude, latest.longitude];

                        let userItem = document.createElement("div");
                        userItem.classList.add("user-item");
                        userItem.innerHTML = `üë§ ${user} <br> ‚è≥ <b>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</b> ${latest.timestamp}`;
                        userItem.onclick = () => showUserHistory(user);
                        userList.appendChild(userItem);

                        if (markers[user]) {
                            markers[user].setLatLng(latlng);
                            markers[user].bindPopup(`<b>${user}</b><br>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${latest.timestamp}`);
                        } else {
                            let marker = L.marker(latlng, { title: user }).addTo(map)
                                .bindPopup(`<b>${user}</b><br>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${latest.timestamp}`)
                                .on('click', () => showUserHistory(user));
                            markers[user] = marker;
                        }
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
        }

        function showUserHistory(userId) {
            fetch(`/api/get_user_history?user_id=${userId}`)
                .then(response => response.json())
                .then(data => {
                    let labels = data.map(d => d.timestamp);
                    let coordinates = data.map(d => ({ x: d.timestamp, y: parseFloat(d.latitude) }));
                    let latlngs = data.map(d => [d.latitude, d.longitude]);

                    locationChart.data.labels = labels;
                    locationChart.data.datasets[0].data = coordinates;
                    locationChart.update();
                    chartContainer.style.display = "block";

                    if (paths[userId]) {
                        map.removeLayer(paths[userId]);
                    }

                    let polyline = L.polyline(latlngs, { color: 'red', weight: 3 }).addTo(map);
                    paths[userId] = polyline;

                    let lastLocation = latlngs[latlngs.length - 1];
                    map.setView(lastLocation, 15, { animate: true });
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
        }

        function closeChart() { 
            chartContainer.style.display = "none"; 
        }

        function deleteAllUsers() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }

            fetch('/api/delete_all_users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                alert('–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã');
                for (let user in markers) {
                    map.removeLayer(markers[user]);
                }
                markers = {};
                userList.innerHTML = "–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π";
                updateUsers();
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            });
        }

        function shareLocation() {
            const userName = document.getElementById('userNameInput').value.trim();
            if (!userName) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }
            const shareLink = `${window.location.origin}/?name=${encodeURIComponent(userName)}`;
            
            navigator.clipboard.writeText(shareLink).then(() => {
                const button = document.querySelector('.input-group button');
                const originalText = button.textContent;
                button.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                button.style.backgroundColor = '#28a745';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.backgroundColor = '#007bff';
                }, 2000);
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é: ' + shareLink);
            });
        }

        setInterval(updateUsers, 5000);
        updateUsers();
    </script>
</body>
</html> 